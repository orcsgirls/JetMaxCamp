<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conveyor Controller (MQTT)</title>
<!-- Correct Paho MQTT JS include -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button { margin: 5px; padding: 10px 20px; font-size: 16px; }
  #statusLight { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-left: 10px; }
  #console { margin-top: 20px; background: #111; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
</style>
</head>
<body>
<h2>Conveyor Controller - <span id="deviceid"></span></h2>
<div>
  <button id="bforward" onclick="sendCommand('forward')">Forward</button>
  <button id = "bbackward" onclick="sendCommand('backward')">Backward</button>
  <button id="bstop" onclick="sendCommand('stop')">Stop</button>
  <span>Status: 
  <span id="statusLight" style="background: gray"></span>
  <span id="statusText">Unknown</span>
  </span>
</div>
<div id="console"></div>

<script>
  //--------------------------------------------------------------------------------------------
  // Configure here
  //--------------------------------------------------------------------------------------------
  
  const host = "192.168.37.111"; // your broker IP
  const port = 8083; // common WebSocket port (adjust if different)
  const clientId = "conveyorUI-" + Math.random().toString(16).substr(2, 8);
  const device = "conveyor01"
  
  //--------------------------------------------------------------------------------------------
  
  document.getElementById("deviceid").innerHTML = "<i>"+device+"</i>";
  
  const client = new Paho.MQTT.Client(host, Number(port), "/mqtt", clientId);

  client.onConnectionLost = onConnectionLost;
  client.onMessageArrived = onMessageArrived;

  client.connect({
    useSSL: false,
    onSuccess: onConnect,
    onFailure: (err) => log("Connection failed: " + JSON.stringify(err))
  });

  function onConnect() {
    log("Connected to broker");
    client.subscribe(device+"/running");
    log("Subscribed to "+device+"/running");
  }

  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      log("Connection lost: " + responseObject.errorMessage);
    }
  }

  function onMessageArrived(message) {
    log("Message arrived: [" + message.destinationName + "] " + message.payloadString);
    if (message.destinationName === "conveyor01/running") {
      updateStatus(message.payloadString);
    }
  }

  function sendCommand(cmd) {
    const message = new Paho.MQTT.Message(cmd);
    message.destinationName = device+"/action";
    client.send(message);
    log("Sent command: " + cmd);
  }

  function toggleButtons(disabled) {
	const bforward = document.getElementById("bforward");
	const bbackward = document.getElementById("bbackward");
	const bstop = document.getElementById("bstop");

	bforward.disabled = disabled;
	bbackward.disabled = disabled;
	bstop.disabled = disabled;
  }
  
  function updateStatus(payload) {
    const light = document.getElementById("statusLight");
    const text = document.getElementById("statusText");
    
	if(payload.toLowerCase().includes("manual")) {
	  light.style.background = "yellow";
      text.textContent = "Manual mode";
	  toggleButtons(true);
	} else {
	  toggleButtons(false);
	  if (payload.toLowerCase() === "forward") {
	    light.style.background = "green";
	    text.textContent = "Running forward";
	  } else if (payload.toLowerCase() === "backward") {
	    light.style.background = "green";
	    text.textContent = "Running backward";
	  } else {
	    light.style.background = "red";
	    text.textContent = "Stopped";
	  }	
	}
  }

  function log(msg) {
    const consoleDiv = document.getElementById("console");
    consoleDiv.innerHTML += "<div>> " + msg + "</div>";
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }
</script>
</body>
</html>
